# 記事18: 募集図面からの物件登録機能
blog_post_18 = BlogPost.find_or_create_by!(public_id: 'floorplan-registration-2026') do |post|
  post.title = "募集図面をアップロードするだけ！AIが物件情報を自動抽出"
  post.summary = "募集図面（マイソク）PDFをアップロードするだけで、AIが建物情報と部屋情報を自動抽出。同一建物の検出機能で、既存建物への部屋追加もスムーズに。"
  post.content = <<~'MARKDOWN'
## 物件登録、もっと簡単にできないか

不動産管理において、**物件情報の登録**は欠かせない業務です。

しかし、従来の登録フローには課題がありました。

> 「募集図面を見ながら、建物名、住所、賃料、設備...一つずつ入力していくのは大変」

> 「この物件、もう登録してあったかな？同じ建物に別の部屋を追加したいだけなのに」

特に、**募集図面（マイソク）**には必要な情報がすべて載っているのに、それを手で転記するのは非効率的です。

そこで今回、**募集図面からの物件登録機能**を実装しました。

## 新しい登録フロー

### ステップ1: 募集図面をアップロード

物件新規登録ボタンを押すと、まず**募集図面のアップロード画面**が表示されます。

- PDFをドラッグ&ドロップ
- 「AI解析」ボタンをクリック

図面がない場合は「スキップして手入力」で従来通りの登録も可能です。

### ステップ2: AI解析で情報を自動抽出

Gemini AIが募集図面を解析し、**建物情報と部屋情報を同時に抽出**します。

```json
{
  "building": {
    "name": "サンシャインマンション渋谷",
    "address": "東京都渋谷区道玄坂1-2-3",
    "building_type": "mansion",
    "structure": "RC造",
    "floors": 10,
    "built_date": "2015-03-01"
  },
  "room": {
    "room_number": "301",
    "room_type": "1LDK",
    "area": 45.5,
    "rent": 120000,
    "management_fee": 8000,
    "deposit": 120000,
    "key_money": 120000,
    "facilities": "エアコン,バス・トイレ別,オートロック"
  }
}
```

抽出された情報は自動的にフォームに入力されます。

### ステップ3: 同一建物の自動検出

ここが今回の機能の**キモ**です。

AIが抽出した建物情報をもとに、**既に登録済みの類似建物を自動検索**します。

```ruby
class BuildingMatcherService
  WEIGHTS = {
    name: 0.4,      # 建物名の類似度
    address: 0.35,  # 住所の類似度
    location: 0.25  # 座標の近さ（100m以内）
  }

  def find_similar(name:, address:, latitude:, longitude:)
    # スコア80%以上 → 自動選択（推奨）
    # スコア50-79% → 候補として表示
    # スコア50%未満 → 新規建物扱い
  end
end
```

**3つの要素でマッチング**:

| 要素 | 重み | 判定方法 |
|------|------|----------|
| 建物名 | 40% | 正規化後のLevenshtein類似度 |
| 住所 | 35% | 都道府県除去後の類似度 |
| 座標 | 25% | PostGIS ST_DWithin（100m以内） |

スコア80%以上の建物が見つかると、**自動的に選択**されます。もちろん、手動で変更も可能です。

### ステップ4: 部屋情報の確認・編集

部屋情報もAI解析結果がプリフィルされています。

設備は前日に実装した**設備マスタ**と連携。「エアコン」も「冷暖房」も正しく認識されます。

### ステップ5: 登録完了

「登録」ボタンを押すと、以下が一括で処理されます：

1. **建物の作成**（または既存建物を使用）
2. **部屋の作成**
3. **募集図面PDFの添付**
4. **サムネイル画像の生成**

登録後は建物詳細画面が自動で開きます。

## 技術的なポイント

### AIプロンプトの設計

建物情報と部屋情報を**同時に抽出**するプロンプトを設計しました。

```ruby
prompt = <<~PROMPT
  あなたは不動産の募集図面を解析する専門家です。

  ## 建物情報（building）
  - name: 建物名
  - address: 所在地
  - building_type: mansion/apartment/house/office
  - structure: 構造（RC造など）
  - floors: 総階数
  - built_date: 築年月

  ## 部屋情報（room）
  - room_number: 部屋番号
  - room_type: 間取り（1K, 1LDK, 2DK...）
  - area: 専有面積
  - rent: 賃料
  ...

  JSONのみを出力してください。
PROMPT
```

従来の部屋情報だけの解析から、**建物情報も含めた包括的な解析**に拡張しました。

### ステップウィザードUI

Material-UIの`Stepper`コンポーネントを使用し、4ステップのウィザード形式で実装。

```jsx
const steps = ['募集図面', '建物情報', '部屋情報', '確認'];

<Stepper activeStep={activeStep}>
  {steps.map((label) => (
    <Step key={label}>
      <StepLabel>{label}</StepLabel>
    </Step>
  ))}
</Stepper>
```

各ステップで「戻る」「次へ」が可能。途中で中断しても、入力内容は保持されます。

### 座標による近接検索

PostGISの`ST_DWithin`関数を使用し、**100メートル以内の建物**を高速検索。

```ruby
scope :within_radius, ->(lat, lng, radius_meters) {
  where(
    "ST_DWithin(location, ST_SetSRID(ST_MakePoint(?, ?), 4326)::geography, ?)",
    lng, lat, radius_meters
  )
}
```

住所が微妙に異なっても、座標が近ければ同一建物の可能性が高い。地理空間データベースならではの検索です。

## 活用シーン

### 新規物件の登録

仲介会社から届いた募集図面を、そのままアップロード。手入力の手間を大幅削減。

### 既存建物への部屋追加

「301号室は登録済み、今回は302号室を追加」という場合も、自動で同一建物を検出。

### 複数物件の一括登録

大量の募集図面を処理する際、AI解析で入力時間を短縮。

## 今後の展望

### 複数部屋の一括登録

1つの募集図面に複数部屋が掲載されている場合、一括で登録できるように。

### 解析精度の向上

募集図面のフォーマットは多種多様。解析精度を継続的に改善していきます。

### 類似建物検出の高度化

外観写真のAI比較など、より高精度な同一建物検出を検討中。

## まとめ

**募集図面をアップロードするだけで、物件登録が完了する**。

- AIが建物情報・部屋情報を自動抽出
- 既存建物との重複を自動検出
- 設備マスタと連携した正規化
- サムネイル自動生成

不動産業務の効率化を、一歩進めることができました。

ぜひ、物件新規登録ボタンから試してみてください。
  MARKDOWN
  post.status = :published
  post.published_at = Time.zone.parse('2026-01-06 18:00:00')
  post.commit_hash = nil
end

puts "✓ 記事作成: #{blog_post_18.title}"
