# LINE Messaging API 連携 セットアップガイド

CoCoSumoでLINEメッセージング機能を利用するための設定手順です。

## 目次

1. [LINE公式アカウントの作成](#1-line公式アカウントの作成)
2. [LINE Developersでチャネルを作成](#2-line-developersでチャネルを作成)
3. [チャネル認証情報の取得](#3-チャネル認証情報の取得)
4. [CoCoSumo管理画面での設定](#4-cocosumo管理画面での設定)
5. [Webhook URLの設定](#5-webhook-urlの設定)
6. [接続テスト](#6-接続テスト)
7. [友だち追加の案内](#7-友だち追加の案内)
8. [顧客へのメッセージ送信](#8-顧客へのメッセージ送信)
9. [メッセージテンプレートの作成](#9-メッセージテンプレートの作成)
10. [トラブルシューティング](#10-トラブルシューティング)

---

## 1. LINE公式アカウントの作成

LINE Messaging APIを利用するには、まずLINE公式アカウントが必要です。

1. [LINE Official Account Manager](https://manager.line.biz/) にアクセス
2. LINEアカウントでログイン
3. 「アカウントを作成」をクリック
4. アカウント情報を入力
   - **アカウント名**: 会社名や店舗名（顧客に表示されます）
   - **業種**: 「不動産」を選択
   - **メールアドレス**: 管理用のメールアドレス
5. 利用規約に同意し、アカウントを作成

> **注意**: LINE公式アカウントの「応答設定」で、**応答メッセージ**を「オフ」に設定してください。CoCoSumoからメッセージを送信するため、LINE側の自動応答は不要です。

---

## 2. LINE Developersでチャネルを作成

1. [LINE Developers Console](https://developers.line.biz/console/) にアクセス
2. LINE公式アカウントと同じLINEアカウントでログイン
3. **プロバイダーを作成**（未作成の場合）
   - 「新規プロバイダー作成」をクリック
   - プロバイダー名を入力（会社名など）
4. **Messaging APIチャネルを作成**
   - プロバイダー内で「新規チャネル作成」をクリック
   - チャネルの種類で「**Messaging API**」を選択
   - 必要情報を入力:
     - **チャネル名**: LINE公式アカウント名と同じ
     - **チャネル説明**: サービスの説明
     - **大業種/小業種**: 「不動産」関連を選択
   - 「作成」をクリック

---

## 3. チャネル認証情報の取得

作成したチャネルから3つの認証情報を取得します。

### Channel ID

1. チャネルの「チャネル基本設定」タブを開く
2. 「チャネルID」の値をコピー

### Channel Secret

1. 同じ「チャネル基本設定」タブ内
2. 「チャネルシークレット」の値をコピー

### Channel Access Token（長期）

1. 「Messaging API設定」タブを開く
2. ページ下部の「チャネルアクセストークン（長期）」セクション
3. 「発行」ボタンをクリック
4. 発行されたトークンをコピー

> **重要**: Channel SecretとChannel Access Tokenは機密情報です。外部に漏洩しないよう厳重に管理してください。

---

## 4. CoCoSumo管理画面での設定

1. CoCoSumoにログイン
2. サイドメニューから **管理 → LINE設定** を開く
3. 「LINE Messaging API 設定」セクションに、取得した認証情報を入力:
   - **Channel ID**: コピーしたチャネルID
   - **Channel Secret**: コピーしたチャネルシークレット
   - **Channel Access Token**: コピーしたチャネルアクセストークン
4. 「友だち追加時の設定」セクション（任意）:
   - **挨拶メッセージ**: 友だち追加時に自動送信されるメッセージを入力
     - 例: `友だち追加ありがとうございます！お部屋探しのご相談はこちらからお気軽にメッセージください。`
   - **リッチメニューID**: LINE Developers Consoleで作成したリッチメニューのID（任意）
5. 「LINE連携を有効にする」がオンになっていることを確認
6. 「**保存**」をクリック

---

## 5. Webhook URLの設定

保存後、CoCoSumo画面に **Webhook URL** が表示されます。このURLをLINE Developers Consoleに設定します。

1. CoCoSumo画面に表示されたWebhook URLをコピー（コピーボタンで簡単にコピーできます）
2. [LINE Developers Console](https://developers.line.biz/console/) に戻る
3. 作成したチャネルの「**Messaging API設定**」タブを開く
4. 「Webhook設定」セクション:
   - **Webhook URL**: コピーしたURLを貼り付け
   - 「**更新**」をクリック
   - 「**Webhookの利用**」をオンにする
5. 「**検証**」ボタンをクリックして接続を確認
   - 「成功しました」と表示されればOK

---

## 6. 接続テスト

CoCoSumo側でも接続を確認します。

1. CoCoSumoの **LINE設定** 画面に戻る
2. 「**接続テスト**」ボタンをクリック
3. テスト成功時:
   - 「接続テスト成功」と表示
   - Bot名（LINE公式アカウント名）が表示される
   - ステータスが「**接続確認済み**」に変わる
4. テスト失敗時:
   - エラーメッセージを確認し、Channel ID / Secret / Tokenが正しいか確認
   - [トラブルシューティング](#10-トラブルシューティング)を参照

---

## 7. 友だち追加の案内

顧客にLINEメッセージを送信するには、顧客が先にLINE公式アカウントを **友だち追加** する必要があります。

### 友だち追加の方法

以下のいずれかの方法で顧客に友だち追加を案内してください。

- **QRコード**: LINE Developers Console → Messaging API設定 → QRコードを印刷・掲示
- **友だち追加URL**: LINE Official Account Manager → 友だち追加ガイド → URLを共有
- **店頭POPや名刺**: QRコードを印刷して設置

### 友だち追加されると

顧客が友だち追加すると、自動的に以下の処理が行われます:

1. 顧客のLINEプロフィール情報を取得
2. CoCoSumoの顧客レコードに `line_user_id` を自動紐付け
3. 新規顧客の場合は顧客レコードと案件を自動作成
4. 設定済みの挨拶メッセージを自動送信

---

## 8. 顧客へのメッセージ送信

友だち追加済みの顧客にLINEメッセージを送信できます。

1. **顧客詳細ページ**を開く
2. ヘッダーの緑色の「**LINE**」ボタンをクリック
3. 送信ダイアログで以下を設定:
   - **メッセージタイプ**を選択:
     - **テキスト**: 自由入力またはテンプレートから選択
     - **画像**: HTTPS画像URLを指定
     - **物件カード**: 部屋を検索・選択して物件情報カードを送信
   - **関連する案件**を選択
4. 「**送信**」をクリック → 確認ダイアログで「送信する」

送受信したメッセージは顧客のアクティビティ（チャットビュー）にメールと統合して表示されます。

---

## 9. メッセージテンプレートの作成

よく使うメッセージをテンプレートとして登録しておくと、送信時に素早く選択できます。

1. サイドメニューから **管理 → LINEテンプレート** を開く
2. 「テンプレート追加」をクリック
3. テンプレート情報を入力:
   - **テンプレート名**: 管理用の名前（例: 「内見案内」）
   - **メッセージタイプ**: テキスト / 画像 / Flex
   - **内容**: メッセージ本文
4. 以下のテンプレート変数が使用可能:
   - `{{お客様名}}` — 顧客名
   - `{{会社名}}` — テナント（会社）名
   - `{{担当者名}}` — 送信担当者名
   - `{{物件名}}` — 物件名
5. 「保存」をクリック

### テンプレート例

```
{{お客様名}}様

お世話になっております。{{会社名}}の{{担当者名}}です。

ご希望の条件に合う物件が見つかりましたのでご案内いたします。
内見のご予約はこちらからお気軽にメッセージください。
```

---

## 10. トラブルシューティング

### 接続テストが失敗する

| 原因 | 対処法 |
|------|--------|
| Channel ID/Secret/Tokenが間違っている | LINE Developers Consoleで値を再確認し、コピーし直す |
| Channel Access Tokenが未発行 | Messaging API設定タブで「発行」ボタンをクリック |
| チャネルが無効化されている | LINE Developers Consoleでチャネルのステータスを確認 |

### Webhook検証が失敗する

| 原因 | 対処法 |
|------|--------|
| Webhook URLが間違っている | CoCoSumo画面に表示されるURLを正確にコピー |
| サーバーがHTTPSでない | 本番環境のHTTPS URLを使用しているか確認 |
| Webhookの利用がオフ | LINE Developers Consoleで「Webhookの利用」をオンにする |

### 顧客にメッセージが送れない

| 原因 | 対処法 |
|------|--------|
| 顧客が友だち追加していない | QRコードやURLで友だち追加を案内 |
| 顧客がブロックしている | ブロック時は `line_user_id` がクリアされ送信不可 |
| LINE連携が無効 | LINE設定で「LINE連携を有効にする」をオンにする |

### 顧客からのメッセージが届かない

| 原因 | 対処法 |
|------|--------|
| Webhookの利用がオフ | LINE Developers Consoleで確認 |
| 応答メッセージがオン | LINE Official Account Managerで応答メッセージをオフにする |
| サーバーエラー | アプリケーションログを確認 |

---

## 料金について

LINE Messaging APIの料金プランについては [LINE公式アカウント料金プラン](https://www.linebiz.com/jp/service/line-official-account/plan/) を確認してください。無料プランでは月間のメッセージ配信数に上限があります。
